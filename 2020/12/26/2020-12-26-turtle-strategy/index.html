<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"mikelhsia.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Last post in 2020. See you, 2020. See you, in 2021.   The Turtle Traders experiment was conducted in the early 1980s by Richard Dennis and William Eckhardt to see whether anyone could be taught how t">
<meta property="og:type" content="article">
<meta property="og:title" content="Experiment of Turtle trading strategy">
<meta property="og:url" content="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/index.html">
<meta property="og:site_name" content="Michael&#39;s blog">
<meta property="og:description" content="Last post in 2020. See you, 2020. See you, in 2021.   The Turtle Traders experiment was conducted in the early 1980s by Richard Dennis and William Eckhardt to see whether anyone could be taught how t">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/cover.jpg">
<meta property="og:image" content="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/daily.png">
<meta property="og:image" content="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/15m+40MA&200MA(daily).png">
<meta property="og:image" content="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/15m+40MA&200MA(15minutes).png">
<meta property="og:image" content="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/day_and_min_compare.png">
<meta property="og:image" content="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/15m+40MA&200MA(daily)+stockpicking.png">
<meta property="article:published_time" content="2020-12-26T05:11:59.000Z">
<meta property="article:modified_time" content="2021-08-27T17:23:33.509Z">
<meta property="article:author" content="Michael Hsia">
<meta property="article:tag" content="Strategy">
<meta property="article:tag" content="Momentum">
<meta property="article:tag" content="Backtesting">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/cover.jpg">

<link rel="canonical" href="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Experiment of Turtle trading strategy | Michael's blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177399736-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-177399736-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Michael's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Michael's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Life-long Learning</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://mikelhsia.github.io/2020/12/26/2020-12-26-turtle-strategy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Michael Hsia">
      <meta itemprop="description" content="Free your potential with learning for the rest of your life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Michael's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Experiment of Turtle trading strategy
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-26 13:11:59" itemprop="dateCreated datePublished" datetime="2020-12-26T13:11:59+08:00">2020-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-08-28 01:23:33" itemprop="dateModified" datetime="2021-08-28T01:23:33+08:00">2021-08-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Quantitative-Trading/" itemprop="url" rel="index"><span itemprop="name">Quantitative Trading</span></a>
                </span>
            </span>

          
            <span id="/2020/12/26/2020-12-26-turtle-strategy/" class="post-meta-item leancloud_visitors" data-flag-title="Experiment of Turtle trading strategy" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/12/26/2020-12-26-turtle-strategy/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/12/26/2020-12-26-turtle-strategy/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>Last post in 2020. See you, 2020. See you, in 2021.</p>
</blockquote>
<img data-src="/2020/12/26/2020-12-26-turtle-strategy/cover.jpg" class="" width="400">
<p>The Turtle Traders experiment was conducted in the early 1980s by <strong>Richard Dennis</strong> and <strong>William Eckhardt</strong> to see whether anyone could be taught how to make money in trading. Therefore, the trading strategy that has been taught to these apprentices is named after this experiment as “<strong>Turtle Strategy</strong>“.</p>
<p>In this post, we’re going to quickly go through the turtle strategy itself, and I’m going to experiment with a few things against the backtesting platform that I’m checking out recently: <a target="_blank" rel="noopener" href="https://joinquant.com"><strong>JoinQuant</strong></a>.</p>
<a id="more"></a>
<p>This post will be split into below sections:</p>
<ul>
<li>Quick intro</li>
<li>Objectives</li>
<li>Backtesting</li>
<li>Summary</li>
<li>Reference</li>
<li>Code Reference</li>
</ul>
<p>Here is the Chinese version of this post in case anyone is interested: <a target="_blank" rel="noopener" href="https://www.joinquant.com/view/community/detail/30796">经典海龟策略-股票多标的-短线趋势长线追击双系统</a>.</p>
<h1 id="Quick-intro"><a href="#Quick-intro" class="headerlink" title="Quick intro"></a>Quick intro</h1><p>I’m going to piggyback the existing posts so I don’t have to repeat the lengthy history of turtle experiment here. You can quickly read through the below posts to get an idea of what turtle strategy is about:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://analyzingalpha.com/turtle-trading">Analyzing alpha - turtle trading</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/datadriveninvestor/making-money-with-algo-trading-for-dummies-the-turtle-trading-agent-3b1febe685df">Medium reading - turtle trading</a></li>
</ul>
<p>In short, the turtle strategy is a momentum strategy that uses the <a target="_blank" rel="noopener" href="https://www.investopedia.com/terms/d/donchianchannels.asp"><strong>Donchian channel</strong></a> as the indicator to buy when we spotted the bullish trend and to sell when the trend goes bearish. Turtle strategy also builds two similar systems to capture both strong and weak movements, along with an internal mechanism to manage the risk of loss of capital to 2% in one trading day.</p>
<h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>Implementing the turtle strategy is not a new thing to the quant industry. Therefore, I would like to instead experiment with a few additional things that might benefit the process of the quant research:</p>
<ul>
<li>Most of the quant strategies that you can see in the quant-trading backtest platforms scattered their function definitions and variables all over the places. I’m gonna adopt the <code>object-oriented programming</code> concept in this implementation to increase the reusability and readability of the code.</li>
<li>By instantiating the instance of <code>class TurtleSystemManager()</code>, we persist the data in this instance across the entire backtesting time span.</li>
<li>To decrease the complexity of the positions, capital, and available cash of these two systems in one algorithm trading script, we use <code>context.subportfolios</code> in JoinQuant to simplify the logic and codes.</li>
</ul>
<h1 id="Backtesting"><a href="#Backtesting" class="headerlink" title="Backtesting"></a>Backtesting</h1><p>The setup in my version of implementation are:</p>
<ul>
<li>Run every 15 minutes to calculate and inspect the trading signals</li>
<li>The stock pool updates each month with the latest fundamental data</li>
<li>The trading target in the original turtle strategy is the stock futures, but we’re looking at the stocks in China stock market. So we need to make several adjustments accordingly:<ul>
<li><strong>risk_ratio</strong><ul>
<li>The leverage_ratio in original turtle strategy is 10 while trading stock futures. Here we make it <strong>0.1</strong> so that our greatest loss per day is limited to 0.1%, and also we’re able to buy more stocks.</li>
</ul>
</li>
<li><strong>capacity_per_system</strong><ul>
<li>The stock pool that we update each month contains more than 20 stocks. As turtle strategy is about buying positions at several prices along with the price soar (vise versa in the sell/short side), we place a limit of maximum of 8 stocks per system to make sure we place our capital in the stocks we preferred other than spreading the capital in dozens of stocks.</li>
</ul>
</li>
</ul>
</li>
<li>We use <code>40-day moving average &gt; 200-day moving average</code> as the secondary trading signal to confirm the bullish trend.</li>
<li>Apply <a target="_blank" rel="noopener" href="https://medium.com/@Weeknight_BTC/donchian-channels-catching-the-trend-with-the-four-week-rule-77032c6a2155">Donchian middle line</a> to replace the Donchian low watermark as the new exit signal.</li>
<li>As the China stock market policy prevents us from selling the positions that we buy on the same day, we apply another rule in our strategy that we need to hold the stock at least till the next available bar (which is the next day). See detail in <a target="_blank" rel="noopener" href="https://www.joinquant.com/view/community/detail/b4843ea0026a466190f6f58b50eae50c">海龟策略应用在中国A股（股票）里的缺陷讨论（按分钟回测）</a>.</li>
</ul>
<p>And here are the results of the backtesting of the turtle strategy:</p>
<h2 id="Backtest-1"><a href="#Backtest-1" class="headerlink" title="Backtest 1"></a>Backtest 1</h2><p><strong>Setup:</strong><br>Run the strategy once per day, and no specific sorting rules in the stock pool.</p>
<p><strong>Result:</strong><br><img data-src="/2020/12/26/2020-12-26-turtle-strategy/daily.png" class="" width="600"></p>
<p><strong>Comment:</strong><br>Ummm… The performance is fairly poor but expected. We trade only once per day on the signal without monitoring the price movement for the rest of the day. It is pretty much like you buy a stock when you see the right price on the TV, and then you go play with your cats and dogs until the next day. If any trader can make money like this, anyone on earth can be a trader and no one lose money in the market.</p>
<h2 id="Backtest-2"><a href="#Backtest-2" class="headerlink" title="Backtest 2"></a>Backtest 2</h2><p><strong>Setup:</strong><br>Run every 15 minutes, no specific sorting rules in the stock pool, and use <code>daily</code> close price to build the 40-day and 200-day moving average.</p>
<p><strong>Result:</strong><br><img data-src="/2020/12/26/2020-12-26-turtle-strategy/15m+40MA&200MA(daily).png" class="" width="600"></p>
<p><strong>Comment:</strong><br>The risk control is stronger when you monitor the stock movements every 15 minutes, and you’ll be able to control the daily loss within <code>2N</code> as instructed in the turtle experiment. As for the upward trend, the 15-minute interval also helps the program more accurately capture the entry signal to gain profit. However, the log messages also reveal that there are several times that you won’t be able to close your positions on the day. This represents that your position is exposed outside the risk control management system, causing a tremendous loss when the stock price dropping.</p>
<h2 id="Backtest-3"><a href="#Backtest-3" class="headerlink" title="Backtest 3"></a>Backtest 3</h2><p><strong>Setup:</strong><br>Run every 15 minutes, no specific sorting rules in the stock pool, and use <code>15-minute</code> close price to build the 40-day and 200-day moving average.</p>
<p><strong>Result:</strong><br><img data-src="/2020/12/26/2020-12-26-turtle-strategy/15m+40MA&200MA(15minutes).png" class="" width="600"></p>
<p><strong>Comment:</strong><br>Urgh….. I thought if I increase the granularity of the secondary indicator (40MA &gt; 200MA) from 1 day to 15 minutes, the more accurate entry signals and more profit would be generated. By looking at the diagrams below, more signals do generate as the available cash is lower in the 15-minute scenario.<br><img data-src="/2020/12/26/2020-12-26-turtle-strategy/day_and_min_compare.png" class="" width="600"><br>However, from the log messages you’ll notice that due to the limitation of the China stock market mentioned above, that there are risks that you buy the stock in the morning but things turned sour in the afternoon. Then all you can do is to look at the price go south and sweating all over your face. So we can kind of concluding that using <code>daily</code> close price would be a mean of <strong>smoothing</strong> the data to avoid the zig-zag on price movement.</p>
<h2 id="Backtest-4"><a href="#Backtest-4" class="headerlink" title="Backtest 4"></a>Backtest 4</h2><p><strong>Setup:</strong><br>Run every 15 minutes, sort and rank the stock pool monthly, and use <code>daily</code> close price to build the 40-day and 200-day moving average.</p>
<p><strong>Result:</strong><br><img data-src="/2020/12/26/2020-12-26-turtle-strategy/15m+40MA&200MA(daily)+stockpicking.png" class="" width="600"></p>
<p><strong>Comment:</strong><br>According to what has been described in the book of turtle strategy and the characteristics of volatility of future itself, I sorted and ranked the stocks in Shanghai Shenzhen 300 index in order to identify the stocks that have higher profitability than the others. The rules and the factors that I used are as follow:</p>
<ul>
<li><strong>goods_sale_and_service_to_revenue</strong>: Of course the sales revenue should represent a higher percentage in the total revenue income, indicating the major business is doing great.</li>
<li><strong>peg_ratio</strong>: A ratio to replace the traditional pe_ratio as Peter Lynch suggested. We’re looking at under-estimated stocks(omitting the stocks that peg_ratio is negative).</li>
<li><strong>debt_to_equity_ratio</strong>: The less debt the better.</li>
<li><strong>FCF (Free Cash Flow)</strong>: The more free cash flow the better.</li>
<li><strong>turnover_ratio</strong>: Turtle strategy suggests us to target the markets that have a higher turnover ratio as in essence, turtle strategy is still a momentum strategy that looks for stocks that have high liquidity.</li>
<li><strong>pb_ratio</strong>: Also, we need to find stocks that are underestimated.</li>
</ul>
<p>I was hoping that my petty trick would work and make the portfolio return better off. Sadly, it didn’t.</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>Even though the backtesting results above are not promising nor profitable for us to proceed to live trading, the objectives of this experiment have been achieved. We can use an object-oriented programming way of coding style inside these backtesting platforms. By doing so, the code can be reused when we implement our own automatic trading script later, reducing the time to rewrite everything the second time.</p>
<p>Other than that, we have also identified some limitations of running turtle strategy in the China stock market:</p>
<ol>
<li>The China stock market has the policy that restricts day-trading (selling the stocks that you purchased that day), leaving the risk of our positions uncontrolled.</li>
<li>One lot in China stock market represents 100 shares. Any number of shares that are under 100 are not able to be purchased. This would raise the bar of purchasing stocks whose price are higher as we need to relocate our capital to several stocks in the strategy.</li>
<li>Monitoring and trading several stocks in one turtle strategy is not preferable since it increases the complexity of managing positions during both bullish and bearish trend.</li>
</ol>
<p>But there are other thoughts that we still can extend and develop upon the turtle strategy we built:</p>
<ol>
<li>We can see that the Donchian channel in turtle strategy is a lag indicator, meaning the momentum might have already passed when our indicators tell us to buy or sell. Therefore we might be able to switch to another indicator such as MACD or RSI so that we can spot the buy/sell opportunities in a quicker fashion.</li>
<li>We can also reverse the signals to buy when we see sell signals and to sell when we see buy signals. This means that we’re going to use the turtle strategy as a <code>mean reversion strategy</code> instead of the original <code>momentum strategy</code>.</li>
</ol>
<p>To summarize, this strategy is not going toward the live trading stage in the short run. The code can only be used as a template or reference for anyone here to implement their version of the turtle system by overwriting the detail in each class function.</p>
<p>Enjoy! Cheers!</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.joinquant.com/post/1401">【量化课堂】海龟策略</a></li>
<li><a target="_blank" rel="noopener" href="https://www.joinquant.com/view/community/detail/284a9688a58e0112b3bad8c1283548bc">海龟策略精讲</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mikelhsia/quantitative-research/files/5650936/the_original_turtle_trading_rules.pdf">The Original Turtle Trading Rules</a></li>
<li><a target="_blank" rel="noopener" href="https://www.businessinsider.com/turtle-trading-rules-trend-following-investing-based-on-20-amp-55-day-highs-2011-8">Turtle trading rules trend-following investing based on 20 amp 55-day highs</a></li>
<li><a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1672154028841339288&amp;wfr=spider&amp;for=pc">唐奇安通道</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/99266983">增强版唐奇安通道策略</a></li>
</ul>
<h1 id="Code-Reference"><a href="#Code-Reference" class="headerlink" title="Code Reference"></a>Code Reference</h1><details>
    <summary>Click here if you want to checkout the source code</summary>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Inspired from: https://www.joinquant.com/post/1401</span></span><br><span class="line"><span class="comment">#                and https://www.joinquant.com/view/community/detail/284a9688a58e0112b3bad8c1283548bc</span></span><br><span class="line"><span class="comment"># 标题：Turtle Strategy that monitors multiple stocks</span></span><br><span class="line"><span class="comment"># 作者：Michael Hsia</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> talib</span><br><span class="line"><span class="keyword">from</span> prettytable <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">enable_profile()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChinaMarketHelper</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">normalize_position</span>(<span class="params">self, position</span>):</span></span><br><span class="line">        <span class="keyword">return</span> int(position / <span class="number">100</span>) * <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TurtleSystemManager</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, short_in_date=<span class="number">20</span>, short_out_date=<span class="number">10</span>, long_in_date=<span class="number">55</span>, long_out_date=<span class="number">20</span></span>):</span></span><br><span class="line">        self.system = [</span><br><span class="line">            TurtleSystem(short_in_date, short_out_date, <span class="literal">True</span>),</span><br><span class="line">            TurtleSystem(long_in_date, long_out_date, <span class="literal">False</span>)</span><br><span class="line">        ]</span><br><span class="line">        <span class="comment"># Capacity in portfolio</span></span><br><span class="line">        self.capacity_per_system = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_turtle_params</span>(<span class="params">self, context</span>):</span></span><br><span class="line">        <span class="keyword">for</span> pindex <span class="keyword">in</span> range(len(context.subportfolios)):</span><br><span class="line">            total_value = context.subportfolios[pindex].total_value</span><br><span class="line">            <span class="keyword">for</span> symbol <span class="keyword">in</span> context.subportfolios[pindex].long_positions.keys():</span><br><span class="line">                self.system[pindex].update_turtle_params_by_symbol(symbol, total_value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_running</span>(<span class="params">self, context, symbol, current_price</span>):</span></span><br><span class="line">        <span class="keyword">for</span> pindex <span class="keyword">in</span> range(len(context.subportfolios)):</span><br><span class="line">            total_value = context.subportfolios[pindex].total_value</span><br><span class="line">            donchian_high_price = max(attribute_history(symbol, self.system[pindex].in_date, <span class="string">&#x27;1d&#x27;</span>, (<span class="string">&#x27;high&#x27;</span>, <span class="string">&#x27;close&#x27;</span>))[<span class="string">&#x27;close&#x27;</span>])</span><br><span class="line">            donchian_low_price = min(attribute_history(symbol, self.system[pindex].out_date, <span class="string">&#x27;1d&#x27;</span>, (<span class="string">&#x27;low&#x27;</span>, <span class="string">&#x27;close&#x27;</span>))[<span class="string">&#x27;close&#x27;</span>])</span><br><span class="line">            donchian_mid_price = (donchian_high_price + donchian_low_price) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> symbol <span class="keyword">not</span> <span class="keyword">in</span> context.subportfolios[pindex].long_positions.keys():</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Limit the number of assets in our portfolio to make sure we&#x27;re able to invest enough money to complete one turtle strategy cycle</span></span><br><span class="line">                <span class="keyword">if</span> len(context.subportfolios[pindex].long_positions) &gt;= self.capacity_per_system:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                ma_40 = mean(attribute_history(symbol, <span class="number">40</span>, <span class="string">&#x27;1d&#x27;</span>, (<span class="string">&#x27;close&#x27;</span>))[<span class="string">&#x27;close&#x27;</span>])</span><br><span class="line">                ma_200 = mean(attribute_history(symbol, <span class="number">200</span>, <span class="string">&#x27;1d&#x27;</span>, (<span class="string">&#x27;close&#x27;</span>))[<span class="string">&#x27;close&#x27;</span>])</span><br><span class="line"></span><br><span class="line">                self.system[pindex].update_turtle_params_by_symbol(symbol, total_value)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (current_price &gt; donchian_high_price) <span class="keyword">and</span> (ma_40 &gt; ma_200):</span><br><span class="line">                    <span class="keyword">if</span> pindex == <span class="number">1</span>:</span><br><span class="line">                        <span class="comment"># Reset previous_state_winning status</span></span><br><span class="line">                        self.system[<span class="number">0</span>].previous_state_winning.discard(symbol)</span><br><span class="line"></span><br><span class="line">                    self.system[pindex].market_in(</span><br><span class="line">                        symbol,</span><br><span class="line">                        pindex</span><br><span class="line">                    )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                avg_cost = context.subportfolios[pindex].long_positions[symbol].acc_avg_cost</span><br><span class="line">                previous_purchased_price = self.system[pindex].get_previous_purchased_price_by_symbol(symbol)</span><br><span class="line">                system_N = self.system[pindex].get_N_from_turtle_params_by_symbol(symbol)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># The reason to add this block has been described in this article</span></span><br><span class="line">                <span class="comment"># https://www.joinquant.com/view/community/detail/30694</span></span><br><span class="line">                <span class="comment"># Clean up the remaining position in the next possible bar</span></span><br><span class="line">                current_position = context.subportfolios[pindex].long_positions[symbol].total_amount + context.subportfolios[pindex].long_positions[symbol].locked_amount</span><br><span class="line">                <span class="keyword">if</span> (current_position != <span class="number">0</span>) <span class="keyword">and</span> (self.system[pindex].system_positions[symbol][<span class="string">&#x27;unit&#x27;</span>] == <span class="number">0</span>):</span><br><span class="line">                    order_target(symbol, <span class="number">0</span>, style=MarketOrderStyle(), pindex=pindex)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 每上涨0.5N，加仓一个单元</span></span><br><span class="line">                <span class="keyword">if</span> current_price &gt;= (previous_purchased_price + <span class="number">0.5</span> * system_N):</span><br><span class="line">                    <span class="keyword">if</span> pindex == <span class="number">1</span>:</span><br><span class="line">                        <span class="comment"># Reset previous_state_winning status if system 2 market in or market add</span></span><br><span class="line">                        self.system[<span class="number">0</span>].previous_state_winning.discard(symbol)</span><br><span class="line"></span><br><span class="line">                    self.system[pindex].market_add(</span><br><span class="line">                        symbol,</span><br><span class="line">                        pindex</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 若当前价格低于前out_date天的收盘价的最小值, 则卖掉所有持仓</span></span><br><span class="line">                <span class="keyword">if</span> current_price &lt; donchian_mid_price:</span><br><span class="line">                    ret = self.system[pindex].market_out(</span><br><span class="line">                        symbol,</span><br><span class="line">                        pindex</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ret == <span class="literal">True</span>:</span><br><span class="line">                        <span class="keyword">if</span> current_price &gt;= avg_cost:</span><br><span class="line">                            self.system[pindex].previous_state_winning.add(symbol)</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            self.system[pindex].previous_state_winning.discard(symbol)</span><br><span class="line">                        <span class="comment"># Don&#x27;t need to run stop loss as this position has already been removed</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 若当前价格低于 2N，则开始止损</span></span><br><span class="line">                <span class="keyword">if</span> (current_price - previous_purchased_price) &lt; (<span class="number">-2</span> * system_N):</span><br><span class="line">                    ret = self.system[pindex].market_stop_loss(</span><br><span class="line">                        symbol,</span><br><span class="line">                        pindex</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ret == <span class="literal">True</span>:</span><br><span class="line">                        self.system[pindex].previous_state_winning.discard(symbol)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TurtleSystem</span>():</span></span><br><span class="line">    TURTLE_N = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">    TURTLE_DOLLAR_VOLATILITY = <span class="string">&#x27;DOLLAR_VOLATILITY&#x27;</span></span><br><span class="line">    TURTLE_UNIT = <span class="string">&#x27;UNIT&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, in_date, out_date, ignore_state=False</span>):</span></span><br><span class="line">        self.in_date = in_date</span><br><span class="line">        self.out_date = out_date</span><br><span class="line">        self.ignore_state = ignore_state</span><br><span class="line">        self.system_positions = &#123;&#125;</span><br><span class="line">        self.turtle_params = &#123;&#125;</span><br><span class="line">        self.previous_state_winning = set()</span><br><span class="line">        self.ignore_state = <span class="literal">True</span></span><br><span class="line">        self.dollars_per_share = <span class="number">1</span>          <span class="comment"># dollars_per_share是标的股票每波动一个最小单位，1手股票的总价格变化量。</span></span><br><span class="line">                                            <span class="comment"># 在国内最小变化量是0.01元，所以就是0.01 × 100=1</span></span><br><span class="line">        self.number_days = <span class="number">20</span>               <span class="comment"># 计算N值的天数</span></span><br><span class="line">        self.unit_limit = <span class="number">4</span>                 <span class="comment"># 4 for the lnog direction</span></span><br><span class="line">        self.risk_ratio = <span class="number">0.1</span>               <span class="comment"># 为了尽量买到更多股票，我把风险比率设为了0.1（因为海龟原</span></span><br><span class="line">                                            <span class="comment"># 来是应用在美国的期货上的，10倍杠杆，A股没杠杆，所以把风</span></span><br><span class="line">                                            <span class="comment"># 险比率设为0.1，这样用于单个品种的买卖资金就和期货一样了），</span></span><br><span class="line">                                            <span class="comment"># 也就是说，按照平均波动幅度的每天最大亏损是0.1%</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">market_in</span>(<span class="params">self, symbol, pindex</span>):</span></span><br><span class="line">        <span class="comment"># System 1 breakout entry signals would be ignored if the last breakout would have resulted in a winning trade</span></span><br><span class="line">        <span class="comment"># All breakouts for System 2 would be taken whether the previous breakout had been a winner or not.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> self.ignore_state) <span class="keyword">and</span> (symbol <span class="keyword">in</span> self.previous_state_winning):</span><br><span class="line">            <span class="comment"># 假如是系统1，就要看之前的trade是win的话，本次就不进入市场了</span></span><br><span class="line">            self.remove_turtle_params_by_symbol(symbol)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;[System &#123;&#125;] - [&#123;&#125;] - 入仓&quot;</span>.format(pindex, symbol))</span><br><span class="line">        self.add_position_by_symbol(</span><br><span class="line">            symbol,</span><br><span class="line">            pindex</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">market_add</span>(<span class="params">self, symbol, pindex</span>):</span></span><br><span class="line">        log.info(<span class="string">&quot;[System &#123;&#125;] - [&#123;&#125;] - 加仓&quot;</span>.format(pindex, symbol))</span><br><span class="line">        self.add_position_by_symbol(symbol, pindex)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">market_out</span>(<span class="params">self, symbol, pindex</span>):</span></span><br><span class="line">        log.info(<span class="string">&quot;[System &#123;&#125;] - [&#123;&#125;] - 减仓&quot;</span>.format(pindex, symbol))</span><br><span class="line">        <span class="keyword">return</span> self.reduce_position_by_symbol(</span><br><span class="line">            symbol,</span><br><span class="line">            pindex</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">market_stop_loss</span>(<span class="params">self, symbol, pindex</span>):</span></span><br><span class="line">        log.debug(<span class="string">&#x27;[System &#123;&#125;] - [&#123;&#125;] 开始止损&#x27;</span>.format(pindex, symbol))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.reduce_position_by_symbol(</span><br><span class="line">            symbol,</span><br><span class="line">            pindex</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_position_by_symbol</span>(<span class="params">self, symbol, pindex</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.system_positions.get(symbol, <span class="literal">None</span>) == <span class="literal">None</span>:</span><br><span class="line">            self.system_positions[symbol] = &#123;&#125;</span><br><span class="line">            self.system_positions[symbol][<span class="string">&#x27;unit&#x27;</span>] = <span class="number">0</span></span><br><span class="line">            self.system_positions[symbol][<span class="string">&#x27;previous_purchased_price&#x27;</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.system_positions[symbol][<span class="string">&#x27;unit&#x27;</span>] &gt;= self.unit_limit:</span><br><span class="line">            <span class="comment"># Reaching unit limit</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        position = self.get_unit_from_turtle_params_by_symbol(symbol)</span><br><span class="line">        position = ChinaMarketHelper.normalize_position(position * self.risk_ratio)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> position &lt; <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        res = order(symbol, position, style=MarketOrderStyle(), pindex=pindex)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> res.status <span class="keyword">not</span> <span class="keyword">in</span> [OrderStatus.canceled, OrderStatus.rejected]:</span><br><span class="line">                self.system_positions[symbol][<span class="string">&#x27;unit&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                self.system_positions[symbol][<span class="string">&#x27;previous_purchased_price&#x27;</span>] = res.price</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                log.warning(<span class="string">&#x27;[System &#123;&#125;] - [&#123;&#125;] order failed: &#123;&#125;.&#x27;</span>.format(pindex, symbol, res))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reduce_position_by_symbol</span>(<span class="params">self, symbol, pindex</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.system_positions.get(symbol, <span class="literal">None</span>) == <span class="literal">None</span>:</span><br><span class="line">            log.warning(<span class="string">&#x27;Reduce position failed. It does not exist&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        res = order_target(symbol, <span class="number">0</span>, style=MarketOrderStyle(), pindex=pindex)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> res.status <span class="keyword">not</span> <span class="keyword">in</span> [OrderStatus.canceled, OrderStatus.rejected]:</span><br><span class="line">                self.system_positions[symbol][<span class="string">&#x27;unit&#x27;</span>] = <span class="number">0</span></span><br><span class="line">                <span class="comment"># https://www.joinquant.com/view/community/detail/30694</span></span><br><span class="line">                <span class="comment"># self.remove_position_by_symbol_if_empty(symbol)</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                log.warning(<span class="string">&#x27;[System &#123;&#125;] - [&#123;&#125;] order failed: &#123;&#125;.&#x27;</span>.format(pindex, symbol, res))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_position_by_symbol_if_empty</span>(<span class="params">self, symbol</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.system_positions.get(symbol, <span class="literal">None</span>) == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.system_positions[symbol][<span class="string">&#x27;unit&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">            self.system_positions.pop(symbol)</span><br><span class="line">            self.remove_turtle_params_by_symbol(symbol)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        log.warning(<span class="string">&#x27;Unit of [&#123;&#125;] is not empty&#x27;</span>.format(symbol))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_previous_purchased_price_by_symbol</span>(<span class="params">self, symbol</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.system_positions.get(symbol, <span class="literal">None</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&#x27; [&#123;&#125;] - System position param does not exist&#x27;</span>.format(symbol))</span><br><span class="line">        <span class="keyword">if</span> self.system_positions[symbol].get(<span class="string">&#x27;previous_purchased_price&#x27;</span>, <span class="literal">None</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&#x27;[&#123;&#125;] - N does not exist&#x27;</span>.format(symbol))</span><br><span class="line">        <span class="keyword">return</span> self.system_positions[symbol][<span class="string">&#x27;previous_purchased_price&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_turtle_params_by_symbol</span>(<span class="params">self, symbol, account_value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_turtle_params_existed_by_symbol(symbol):</span><br><span class="line">            self.turtle_params[symbol] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        df = attribute_history(</span><br><span class="line">            count=self.number_days + <span class="number">1</span>,</span><br><span class="line">            unit=<span class="string">&#x27;1d&#x27;</span>,</span><br><span class="line">            fields=[<span class="string">&#x27;low&#x27;</span>, <span class="string">&#x27;close&#x27;</span>, <span class="string">&#x27;high&#x27;</span>],</span><br><span class="line">            security=symbol,</span><br><span class="line">            df=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        df[<span class="string">&#x27;pdc&#x27;</span>] = df[<span class="string">&#x27;close&#x27;</span>].shift(<span class="number">1</span>)</span><br><span class="line">        df[<span class="string">&#x27;h_l&#x27;</span>] = (df[<span class="string">&#x27;high&#x27;</span>] - df[<span class="string">&#x27;low&#x27;</span>]).abs()</span><br><span class="line">        df[<span class="string">&#x27;h_pdc&#x27;</span>] = (df[<span class="string">&#x27;high&#x27;</span>] - df[<span class="string">&#x27;pdc&#x27;</span>]).abs()</span><br><span class="line">        df[<span class="string">&#x27;pdc_l&#x27;</span>] = (df[<span class="string">&#x27;pdc&#x27;</span>] - df[<span class="string">&#x27;low&#x27;</span>]).abs()</span><br><span class="line">        N = df[[<span class="string">&#x27;h_l&#x27;</span>, <span class="string">&#x27;h_pdc&#x27;</span>, <span class="string">&#x27;pdc_l&#x27;</span>]].max(axis=<span class="number">1</span>)[<span class="number">1</span>:].mean()</span><br><span class="line"></span><br><span class="line">        high = df[<span class="string">&#x27;high&#x27;</span>]</span><br><span class="line">        low = df[<span class="string">&#x27;low&#x27;</span>]</span><br><span class="line">        pdc = df[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">        <span class="keyword">del</span> df</span><br><span class="line"></span><br><span class="line">        self.turtle_params[symbol][self.TURTLE_N] = talib.ATR(high, low, pdc, timeperiod=self.number_days)[<span class="number">-1</span>]</span><br><span class="line">        self.turtle_params[symbol][self.TURTLE_DOLLAR_VOLATILITY] = self.dollars_per_share * self.turtle_params[symbol][self.TURTLE_N]</span><br><span class="line">        self.turtle_params[symbol][self.TURTLE_UNIT] = (account_value * <span class="number">0.01</span>) / self.turtle_params[symbol][self.TURTLE_DOLLAR_VOLATILITY]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_N_from_turtle_params_by_symbol</span>(<span class="params">self, symbol</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_turtle_params_existed_by_symbol(symbol):</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&#x27;N of [&#123;&#125;] does not exist&#x27;</span>.format(symbol))</span><br><span class="line">        <span class="keyword">if</span> self.turtle_params[symbol].get(self.TURTLE_N, <span class="literal">None</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&#x27;N of [&#123;&#125;] does not exist&#x27;</span>.format(symbol))</span><br><span class="line">        <span class="keyword">return</span> self.turtle_params[symbol][self.TURTLE_N]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_unit_from_turtle_params_by_symbol</span>(<span class="params">self, symbol</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_turtle_params_existed_by_symbol(symbol):</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&#x27;N of [&#123;&#125;] does not exist&#x27;</span>.format(symbol))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.turtle_params[symbol][self.TURTLE_UNIT]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_turtle_params_existed_by_symbol</span>(<span class="params">self, symbol</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.turtle_params.get(symbol, <span class="literal">None</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_turtle_params_by_symbol</span>(<span class="params">self, symbol</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.is_turtle_params_existed_by_symbol(symbol):</span><br><span class="line">            self.turtle_params.pop(symbol)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">总体回测前</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>(<span class="params">context</span>):</span></span><br><span class="line">    g.security = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    set_benchmark(<span class="string">&#x27;000300.XSHG&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    set_option(<span class="string">&#x27;use_real_price&#x27;</span>,<span class="literal">True</span>) <span class="comment">#用真实价格交易</span></span><br><span class="line">    set_option(<span class="string">&quot;avoid_future_data&quot;</span>, <span class="literal">True</span>) <span class="comment">#避免使用未来数据</span></span><br><span class="line">    log.set_level(<span class="string">&#x27;order&#x27;</span>,<span class="string">&#x27;error&#x27;</span>) <span class="comment"># 设置报错等级</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># System 1 cash</span></span><br><span class="line">    ratio_system1 = <span class="number">0.8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set up two separate systems:</span></span><br><span class="line">    <span class="comment"># subportfolios[0] is system 1 in the turtle strategy</span></span><br><span class="line">    <span class="comment"># and subportfolios[1] is the system 2</span></span><br><span class="line">    set_subportfolios(</span><br><span class="line">        [SubPortfolioConfig(cash=context.portfolio.starting_cash * ratio_system1, type=<span class="string">&#x27;stock&#x27;</span>),</span><br><span class="line">        SubPortfolioConfig(cash=context.portfolio.starting_cash * (<span class="number">1</span> - ratio_system1), type=<span class="string">&#x27;stock&#x27;</span>)]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    SHORT_IN_DATE = <span class="number">20</span></span><br><span class="line">    SHORT_OUT_DATE = <span class="number">10</span></span><br><span class="line">    LONG_IN_DATE = <span class="number">55</span></span><br><span class="line">    LONG_OUT_DATE = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    g.turtle = TurtleSystemManager(</span><br><span class="line">        SHORT_IN_DATE,</span><br><span class="line">        SHORT_OUT_DATE,</span><br><span class="line">        LONG_IN_DATE,</span><br><span class="line">        LONG_OUT_DATE,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">每天开盘前</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_trading_start</span>(<span class="params">context</span>):</span></span><br><span class="line">    set_slip_fee(context)</span><br><span class="line">    set_tradable_stocks(context)</span><br><span class="line">    g.turtle.update_turtle_params(context)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_slip_fee</span>(<span class="params">context</span>):</span></span><br><span class="line">    set_slippage(FixedSlippage(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    set_order_cost(OrderCost(open_tax=<span class="number">0</span>, close_tax=<span class="number">0.001</span>, open_commission=<span class="number">0.0003</span>, close_commission=<span class="number">0.0003</span>, close_today_commission=<span class="number">0</span>, min_commission=<span class="number">5</span>), type=<span class="string">&#x27;stock&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_tradable_stocks</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="comment"># Run every month</span></span><br><span class="line">    <span class="keyword">if</span> context.current_dt.day == <span class="number">1</span> <span class="keyword">or</span> g.security <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Test one scenario</span></span><br><span class="line">        test = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> test:</span><br><span class="line">            <span class="comment"># 上证50</span></span><br><span class="line">            g.security = get_index_stocks(<span class="string">&#x27;000016.XSHG&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Get yesterday&#x27;s datetime string</span></span><br><span class="line">            date = (context.current_dt - timedelta(days=<span class="number">1</span>)).strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            sh300 = get_index_stocks(normalize_code(<span class="string">&#x27;000300.sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">            sh300_df = get_fundamentals(</span><br><span class="line">                query(</span><br><span class="line">                    valuation.code,</span><br><span class="line">                    valuation.pe_ratio,</span><br><span class="line">                    valuation.turnover_ratio,</span><br><span class="line">                    balance.total_owner_equities,</span><br><span class="line">                    balance.total_sheet_owner_equities,</span><br><span class="line">                    cash_flow.cash_equivalent_increase,</span><br><span class="line">                    cash_flow.cash_equivalents_at_beginning,</span><br><span class="line">                    cash_flow.cash_and_equivalents_at_end,</span><br><span class="line">                    indicator.goods_sale_and_service_to_revenue,</span><br><span class="line">                    indicator.inc_net_profit_year_on_year,</span><br><span class="line">                    valuation.pb_ratio,</span><br><span class="line">                ).filter(</span><br><span class="line">                    valuation.code.in_(sh300),</span><br><span class="line">                    valuation.pe_ratio &gt; <span class="number">0</span>,</span><br><span class="line">                    indicator.inc_net_profit_year_on_year &gt; <span class="number">0</span></span><br><span class="line">                ),</span><br><span class="line">                date=date</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            sh300_df = sh300_df.dropna()</span><br><span class="line">            sh300_df[<span class="string">&#x27;peg_ratio&#x27;</span>] = sh300_df.pe_ratio / sh300_df.inc_net_profit_year_on_year</span><br><span class="line">            sh300_df[<span class="string">&#x27;debt_to_equity_ratio&#x27;</span>] = ((sh300_df.total_sheet_owner_equities - sh300_df.total_owner_equities)/sh300_df.total_owner_equities)</span><br><span class="line">            sh300_df[<span class="string">&#x27;FCF&#x27;</span>] = (sh300_df.cash_and_equivalents_at_end - sh300_df.cash_equivalents_at_beginning)</span><br><span class="line"></span><br><span class="line">            cols = [<span class="string">&#x27;goods_sale_and_service_to_revenue&#x27;</span>, <span class="string">&#x27;peg_ratio&#x27;</span>, <span class="string">&#x27;debt_to_equity_ratio&#x27;</span>, <span class="string">&#x27;FCF&#x27;</span>, <span class="string">&#x27;turnover_ratio&#x27;</span>, <span class="string">&#x27;pb_ratio&#x27;</span>]</span><br><span class="line">            sh300_df.index = sh300_df.code</span><br><span class="line">            sh300_df.index.name = <span class="string">&#x27;Symbol&#x27;</span></span><br><span class="line">            sh300_df = sh300_df[cols]</span><br><span class="line"></span><br><span class="line">            sh300_df[<span class="string">&#x27;goods_sale_and_service_to_revenue&#x27;</span>] = sh300_df[<span class="string">&#x27;goods_sale_and_service_to_revenue&#x27;</span>].rank(ascending=<span class="literal">False</span>)</span><br><span class="line">            sh300_df[<span class="string">&#x27;peg_ratio&#x27;</span>] = sh300_df[<span class="string">&#x27;peg_ratio&#x27;</span>].rank(ascending=<span class="literal">True</span>)</span><br><span class="line">            sh300_df[<span class="string">&#x27;debt_to_equity_ratio&#x27;</span>] = sh300_df[<span class="string">&#x27;debt_to_equity_ratio&#x27;</span>].rank(ascending=<span class="literal">True</span>)</span><br><span class="line">            sh300_df[<span class="string">&#x27;FCF&#x27;</span>] = sh300_df[<span class="string">&#x27;FCF&#x27;</span>].rank(ascending=<span class="literal">False</span>)</span><br><span class="line">            sh300_df[<span class="string">&#x27;turnover_ratio&#x27;</span>] = sh300_df[<span class="string">&#x27;turnover_ratio&#x27;</span>].rank(ascending=<span class="literal">False</span>)</span><br><span class="line">            sh300_df[<span class="string">&#x27;pb_ratio&#x27;</span>] = sh300_df[<span class="string">&#x27;pb_ratio&#x27;</span>].rank(ascending=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            zscore = sh300_df.sum(axis=<span class="number">1</span>).sort_values(ascending=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            g.security = zscore.index.tolist()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> pindex <span class="keyword">in</span> range(len(context.subportfolios)):</span><br><span class="line">            g.security += context.subportfolios[pindex].long_positions.keys()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Remove duplicated positions from the list</span></span><br><span class="line">        g.security = list(set(g.security))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">每天交易时</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 按分钟回测</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_data</span>(<span class="params">context, data</span>):</span></span><br><span class="line">    <span class="comment"># 15 minutes timer</span></span><br><span class="line">    timer = <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> context.current_dt.minute % timer != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">elif</span> (context.current_dt.hour == <span class="number">9</span>) <span class="keyword">and</span> (context.current_dt.minute == <span class="number">30</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> sec <span class="keyword">in</span> g.security:</span><br><span class="line">        current_data = get_current_data()</span><br><span class="line">        <span class="keyword">if</span> current_data[sec].paused <span class="keyword">or</span> current_data[sec].is_st:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        current_price = data[sec].price</span><br><span class="line">        g.turtle.start_running(context, sec, current_price)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">每天收盘后</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">after_trading_end</span>(<span class="params">context</span>):</span></span><br><span class="line">    <span class="keyword">for</span> pindex <span class="keyword">in</span> range(len(context.subportfolios)):</span><br><span class="line">        <span class="keyword">if</span> pindex == <span class="number">0</span>:</span><br><span class="line">            record(cash1=context.subportfolios[pindex].available_cash)</span><br><span class="line">            record(value1=context.subportfolios[pindex].total_value)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record(cash2=context.subportfolios[pindex].available_cash)</span><br><span class="line">            record(value2=context.subportfolios[pindex].total_value)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">策略结束后</span></span><br><span class="line"><span class="string">================================================================================</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_strategy_end</span>(<span class="params">context</span>):</span></span><br><span class="line">    x = PrettyTable([<span class="string">&#x27;System&#x27;</span>, <span class="string">&#x27;TotalValue&#x27;</span>, <span class="string">&#x27;Avail Cash&#x27;</span>, <span class="string">&#x27;Number of positions&#x27;</span>])</span><br><span class="line">    <span class="keyword">for</span> pindex <span class="keyword">in</span> range(len(context.subportfolios)):</span><br><span class="line">        x.add_row([</span><br><span class="line">            <span class="string">f&#x27;System <span class="subst">&#123;pindex&#125;</span>&#x27;</span>,</span><br><span class="line">            context.subportfolios[pindex].total_value,</span><br><span class="line">            context.subportfolios[pindex].available_cash,</span><br><span class="line">            len(context.subportfolios[pindex].long_positions)</span><br><span class="line">        ])</span><br></pre></td></tr></table></figure>
</details>
    </div>
    
      
        <div>
    <p style="color: grey; font-family: Georgia; font-size: 1.2em;"><i>
        Disclaimer: Nothing herein is financial advice or even a recommendation to trade real money. Many platforms exist for simulated trading (paper trading) which can be used for building and developing the strategies discussed. Please use common sense and consult a professional before trading or investing your hard-earned money.
    </i></p>
</div>




      
    

    
    
    
        <div class="reward-container">
  <div>Enjoy reading? Some donations would motivate me to produce more quality content</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Tip
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="Michael Hsia WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="Michael Hsia Alipay">
        <p>Alipay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/stripe.png" alt="Michael Hsia Stripe">
        <p>Stripe</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Strategy/" rel="tag"># Strategy</a>
              <a href="/tags/Momentum/" rel="tag"># Momentum</a>
              <a href="/tags/Backtesting/" rel="tag"># Backtesting</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/12/12/2020-12-12-macd-strategy-follow-up-report/" rel="prev" title="【Cont.】 MACD strategy follow up report">
      <i class="fa fa-chevron-left"></i> 【Cont.】 MACD strategy follow up report
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/01/31/2021-01-31-factor-analysis/" rel="next" title="【Factor analysis】 Vol. 1. Introduction the idea of factor analysis">
      【Factor analysis】 Vol. 1. Introduction the idea of factor analysis <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Quick-intro"><span class="nav-number">1.</span> <span class="nav-text">Quick intro</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Objectives"><span class="nav-number">2.</span> <span class="nav-text">Objectives</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Backtesting"><span class="nav-number">3.</span> <span class="nav-text">Backtesting</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Backtest-1"><span class="nav-number">3.1.</span> <span class="nav-text">Backtest 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Backtest-2"><span class="nav-number">3.2.</span> <span class="nav-text">Backtest 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Backtest-3"><span class="nav-number">3.3.</span> <span class="nav-text">Backtest 3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Backtest-4"><span class="nav-number">3.4.</span> <span class="nav-text">Backtest 4</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary"><span class="nav-number">4.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Code-Reference"><span class="nav-number">6.</span> <span class="nav-text">Code Reference</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Michael Hsia</p>
  <div class="site-description" itemprop="description">Free your potential with learning for the rest of your life</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">tags</span></a>
      </div>

  </nav>
    

  <div class="">

    <div class="">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>

</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Michael Hsia</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'xqc1TRzBeSqWMcMIO6i05hrV-MdYXbMMI',
      appKey     : '8y8oPqyB7YE9KwpM33MRijdR',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : 'https://xqc1trzb.api.lncldglobal.com'
    });
  }, window.Valine);
});
</script>

</body>
</html>
